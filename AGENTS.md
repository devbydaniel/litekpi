# LiteKPI

KPI tracking platform. Self-hostable via Docker Compose.

## Stack

| Layer    | Technology                    |
| -------- | ----------------------------- |
| Backend  | Go 1.21+                      |
| Frontend | React 18+ / TypeScript / Vite |
| Database | PostgreSQL 15+                |
| Deploy   | Docker Compose                |

## Backend

### Structure

Organized by **bounded context** (not by layer):

```
backend/
├── cmd/server/main.go          # Entry point
├── internal/
│   ├── auth/                   # Authentication context
│   ├── product/                # Product & API keys
│   ├── ingest/                 # Data ingestion API
│   ├── dashboard/              # Dashboards & widgets
│   ├── report/                 # Scheduled reports
│   └── platform/               # Shared infrastructure
│       ├── config/
│       ├── database/
│       ├── middleware/
│       ├── router/
│       └── email/
└── migrations/                 # SQL migrations
```

Each bounded context contains: `domain.go`, `repository.go`, `service.go`, `handler.go`

### Libraries

- Router: `chi`
- Database: `pgx`
- Migrations: `golang-migrate/migrate`
- JWT: `golang-jwt/jwt`
- OAuth: `golang.org/x/oauth2`
- Validation: `go-playground/validator`
- Password hashing: Argon2id (`golang.org/x/crypto/argon2`)
- OpenAPI: `swaggo/swag` (generates spec from annotations)

## Frontend

### Structure

Four independent layers: routes, layouts, widgets, and pages.

```
frontend/src/
├── routes/                     # File-based routing (TanStack Router)
│   ├── __root.tsx              # Root route - only routing logic
│   ├── _auth.tsx               # Auth guard (redirects if logged in)
│   ├── _auth/                  # Auth route files
│   ├── _authenticated.tsx      # Auth guard (redirects if not logged in)
│   └── _authenticated/         # Protected route files
├── layouts/                    # Reusable layout components
│   ├── root/index.tsx          # Root layout (dev tools)
│   ├── auth/index.tsx          # Centered card layout
│   └── authenticated/index.tsx # Sidebar + main content layout
├── widgets/                    # Complex reusable UI blocks
│   └── app-sidebar/index.tsx   # Main application sidebar
├── pages/                      # Page implementations
│   ├── auth/
│   │   ├── login/
│   │   │   ├── ui/             # Page-specific components
│   │   │   ├── hooks/          # Page-specific hooks
│   │   │   └── index.tsx       # Page component (uses AuthLayout)
│   │   ├── register/
│   │   └── ...
│   └── products/
│       └── ...
├── shared/                     # Only code used by multiple pages
│   ├── components/
│   ├── hooks/
│   ├── api/
│   │   ├── client.ts           # Base HTTP client
│   │   └── generated/          # Auto-generated by Orval
│   └── types/
└── main.tsx
```

**Conventions:**

- `routes/` - Only routing logic (guards, param extraction). Import and render pages.
- `layouts/` - Accept `children` prop. Independent from routes.
- `widgets/` - Complex, self-contained UI blocks that combine multiple components and may have their own state/logic.
- `pages/` - Import and wrap content with layouts. All page logic lives here.

### Libraries

- Build: Vite
- Routing: TanStack Router (file-based)
- State: TanStack Query
- UI: Tailwind CSS + shadcn/ui
- Forms: React Hook Form
- Charts: Recharts
- API Client: Orval (generates from OpenAPI spec)

## Database

- PostgreSQL with JSONB for flexible tag storage
- No TimescaleDB needed at target volume (<1k points/day)

## Auth

- JWT in httpOnly cookies (stateless)
- OAuth: Google, GitHub (optional, disabled if env vars not set)
- Email verification via SMTP

## Development

```bash
# Start everything (services + backend + frontend)
make dev

# Or start components separately
make dev-services     # PostgreSQL + Mailcatcher
make dev-backend      # Backend with hot-reload (air)
make dev-frontend     # Frontend with HMR (vite)

# Stop services
make dev-stop
```

Dev services:

- PostgreSQL: `localhost:5432` (litekpi/secret)
- Mailcatcher SMTP: `localhost:1025`
- Mailcatcher UI: `http://localhost:1080`
- Swagger UI: `http://localhost:8080/swagger/`

## API Generation

```bash
make api-gen          # Generate OpenAPI spec + TypeScript client
make swagger          # Generate OpenAPI spec only
```

## Database

```bash
make migrate              # Run migrations
make migrate-new name=x   # Create new migration
make migrate-down         # Rollback last migration
```

## Production

```bash
# Build and run (requires .env with secrets)
docker compose build
docker compose up -d
```

Required env vars: `POSTGRES_PASSWORD`, `JWT_SECRET`, `APP_URL`, `API_URL`
